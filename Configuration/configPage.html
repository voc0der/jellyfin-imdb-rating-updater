<!DOCTYPE html>
<html>
<head>
    <title>IMDb Ratings</title>
</head>
<body>
    <div id="ImdbRatingsConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="ImdbRatingsConfigForm">
                    <div class="verticalSection">
                        <h2 class="sectionTitle">IMDb Ratings Settings</h2>

                        <div class="inputContainer">
                            <label class="inputLabel" for="txtMinimumVotes">Minimum Votes Threshold</label>
                            <input id="txtMinimumVotes" type="number" is="emby-input" min="0" max="1000000"
                                   pattern="[0-9]*" required />
                            <div class="fieldDescription">
                                Skip updating items where IMDb has fewer votes than this value. Default: 1000.
                            </div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label>
                                <input id="chkIncludeMovies" type="checkbox" is="emby-checkbox" />
                                <span>Include Movies</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">
                                Update ratings for movies in your library.
                            </div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label>
                                <input id="chkIncludeSeries" type="checkbox" is="emby-checkbox" />
                                <span>Include TV Series</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">
                                Update ratings for TV series in your library. Individual episodes are not updated.
                            </div>
                        </div>
                    </div>

                    <div class="verticalSection" style="margin-top: 2em;">
                        <h2 class="sectionTitle">How It Works</h2>
                        <p style="margin: 0.5em 0;">
                            This plugin downloads the official IMDb ratings flat file daily and updates the
                            <strong>Community Rating</strong> field on all library items that have an IMDb ID.
                            No other metadata (titles, posters, cast, etc.) is modified.
                        </p>
                        <p style="margin: 0.5em 0;">
                            The task runs on a daily schedule (default 3:00 AM) and can also be triggered
                            manually from <strong>Dashboard &rarr; Scheduled Tasks</strong>.
                        </p>
                    </div>

                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var ImdbRatingsConfig = {
            pluginId: 'f5a3c7e1-9b2d-4f6a-8e0c-1d3b5a7c9e2f'
        };

        document.querySelector('#ImdbRatingsConfigPage')
            .addEventListener('pageshow', function () {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(ImdbRatingsConfig.pluginId).then(function (config) {
                    document.querySelector('#txtMinimumVotes').value = config.MinimumVotes;
                    document.querySelector('#chkIncludeMovies').checked = config.IncludeMovies;
                    document.querySelector('#chkIncludeSeries').checked = config.IncludeSeries;
                    Dashboard.hideLoadingMsg();
                }).catch(function (err) {
                    Dashboard.hideLoadingMsg();
                    Dashboard.alert('Failed to load IMDb Ratings configuration.');
                });
            });

        document.querySelector('#ImdbRatingsConfigForm')
            .addEventListener('submit', function (e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(ImdbRatingsConfig.pluginId).then(function (config) {
                    config.MinimumVotes = parseInt(document.querySelector('#txtMinimumVotes').value, 10);
                    config.IncludeMovies = document.querySelector('#chkIncludeMovies').checked;
                    config.IncludeSeries = document.querySelector('#chkIncludeSeries').checked;

                    ApiClient.updatePluginConfiguration(ImdbRatingsConfig.pluginId, config).then(function () {
                        Dashboard.processPluginConfigurationUpdateResult();
                    }).catch(function (err) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to save IMDb Ratings configuration.');
                    });
                }).catch(function (err) {
                    Dashboard.hideLoadingMsg();
                    Dashboard.alert('Failed to load IMDb Ratings configuration.');
                });
                return false;
            });
    </script>
</body>
</html>
