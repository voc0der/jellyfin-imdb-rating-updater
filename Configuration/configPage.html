<!DOCTYPE html>
<html>
<head>
    <title>IMDb Ratings</title>
</head>
<body>
    <div id="ImdbRatingsConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="ImdbRatingsConfigForm">
                    <div class="verticalSection">
                        <h2 class="sectionTitle">IMDb Ratings Settings</h2>

                        <div class="inputContainer">
                            <label class="inputLabel" for="txtMinimumVotes">Minimum Votes Threshold</label>
                            <input id="txtMinimumVotes" type="number" min="1" max="1000000"
                                   pattern="[0-9]*" required class="emby-input" />
                            <div class="fieldDescription">
                                Skip updating items where IMDb has fewer votes than this value. Default: 1.
                                Lower values can increase task duration because more items qualify for updates.
                            </div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label>
                                <input id="chkIncludeMovies" type="checkbox" is="emby-checkbox" />
                                <span>Include Movies</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">
                                Update ratings for movies in your library.
                            </div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label>
                                <input id="chkIncludeSeries" type="checkbox" is="emby-checkbox" />
                                <span>Include TV Series</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">
                                Update ratings for TV series and individual episodes in your library.
                            </div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label>
                                <input id="chkEnableItemDebugLogging" type="checkbox" is="emby-checkbox" />
                                <span>Enable Item Debug Logs</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">
                                Off by default. When enabled, writes sampled per-item debug logs for troubleshooting
                                missing IMDb rows and minimum-vote skips (can increase log volume and task duration).
                            </div>
                        </div>
                    </div>

                    <div class="verticalSection" style="margin-top: 2em;">
                        <h2 class="sectionTitle">How It Works</h2>
                        <p style="margin: 0.5em 0;">
                            This plugin downloads the official IMDb ratings flat file daily and updates the
                            <strong>Community Rating</strong> field on all library items that have an IMDb ID.
                            No other metadata (titles, posters, cast, etc.) is modified.
                        </p>
                        <p style="margin: 0.5em 0;">
                            The task runs on a daily schedule (default 3:00 AM) and can also be triggered
                            manually from <strong>Dashboard &rarr; Scheduled Tasks</strong>.
                        </p>
                    </div>

                    <div>
                        <button id="btnSave" is="emby-button" type="button" class="raised button-submit block">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var ImdbRatingsConfig = {
            pluginId: 'f5a3c7e1-9b2d-4f6a-8e0c-1d3b5a7c9e2f'
        };

        function getConfigValue(config, pascalKey, camelKey, fallbackValue) {
            if (config && config[pascalKey] !== undefined && config[pascalKey] !== null) {
                return config[pascalKey];
            }

            if (config && config[camelKey] !== undefined && config[camelKey] !== null) {
                return config[camelKey];
            }

            return fallbackValue;
        }

        function setConfigValue(config, pascalKey, camelKey, value) {
            if (Object.prototype.hasOwnProperty.call(config, camelKey)) {
                config[camelKey] = value;
            }

            // Also set PascalCase for compatibility with plugin pages expecting CLR property names.
            config[pascalKey] = value;
        }

        function getSanitizedMinimumVotesInput() {
            var parsed = parseInt(document.querySelector('#txtMinimumVotes').value, 10);
            if (!Number.isFinite(parsed)) {
                return 1;
            }

            if (parsed < 1) {
                return 1;
            }

            if (parsed > 1000000) {
                return 1000000;
            }

            return parsed;
        }

        document.querySelector('#ImdbRatingsConfigPage')
            .addEventListener('pageshow', function () {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(ImdbRatingsConfig.pluginId).then(function (config) {
                    var minimumVotes = parseInt(getConfigValue(config, 'MinimumVotes', 'minimumVotes', 1), 10);
                    if (!Number.isFinite(minimumVotes) || minimumVotes < 1) {
                        minimumVotes = 1;
                    }

                    document.querySelector('#txtMinimumVotes').value = minimumVotes;
                    document.querySelector('#chkIncludeMovies').checked = !!getConfigValue(config, 'IncludeMovies', 'includeMovies', true);
                    document.querySelector('#chkIncludeSeries').checked = !!getConfigValue(config, 'IncludeSeries', 'includeSeries', true);
                    document.querySelector('#chkEnableItemDebugLogging').checked = !!getConfigValue(
                        config,
                        'EnableItemDebugLogging',
                        'enableItemDebugLogging',
                        false);
                    Dashboard.hideLoadingMsg();
                }).catch(function (err) {
                    Dashboard.hideLoadingMsg();
                    Dashboard.alert('Failed to load IMDb Ratings configuration.');
                });
            });

        document.querySelector('#btnSave')
            .addEventListener('click', function () {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(ImdbRatingsConfig.pluginId).then(function (config) {
                    setConfigValue(config, 'MinimumVotes', 'minimumVotes', getSanitizedMinimumVotesInput());
                    setConfigValue(config, 'IncludeMovies', 'includeMovies', document.querySelector('#chkIncludeMovies').checked);
                    setConfigValue(config, 'IncludeSeries', 'includeSeries', document.querySelector('#chkIncludeSeries').checked);
                    setConfigValue(
                        config,
                        'EnableItemDebugLogging',
                        'enableItemDebugLogging',
                        document.querySelector('#chkEnableItemDebugLogging').checked);

                    ApiClient.updatePluginConfiguration(ImdbRatingsConfig.pluginId, config).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    }).catch(function (err) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to save IMDb Ratings configuration.');
                    });
                }).catch(function (err) {
                    Dashboard.hideLoadingMsg();
                    Dashboard.alert('Failed to load IMDb Ratings configuration.');
                });
            });
    </script>
</body>
</html>
